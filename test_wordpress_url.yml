---
- name: Cek kesehatan semua website WordPress
  hosts: localhost
  gather_facts: false

  vars:
    wordpress_sites:
      - name: WordPress Test
        url: http://192.168.56.104:30149

  tasks:

    - name: Loop per website WordPress
      block:

        - name: ğŸ” Cek koneksi ke {{ item.name }}
          uri:
            url: "{{ item.url }}"
            return_content: yes
            timeout: 10
          register: result
          failed_when: false
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

        - name: ğŸŒ Tampilkan status HTTP {{ item.name }}
          debug:
            msg: "Status code {{ result.status }} untuk {{ item.url }}"
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

        - name: â— Deteksi error koneksi database
          debug:
            msg: "â— [{{ item.name }}] Error: Tidak bisa konek ke database!"
          when: "'Error establishing a database connection' in result.content"
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

        - name: âš ï¸ Deteksi halaman setup WordPress
          debug:
            msg: "âš ï¸ [{{ item.name }}] WordPress belum dikonfigurasi (setup-config.php)"
          when: "'setup-config.php' in result.content or 'Setup Configuration File' in result.content"
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

        - name: âœ… Halaman WordPress tampil normal
          debug:
            msg: "âœ… [{{ item.name }}] WordPress aktif & halaman tampil normal!"
          when: "'WordPress' in result.content and result.status == 200"
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

        - name: ğŸ“ Preview isi halaman
          debug:
            msg: |
              ğŸ“ [{{ item.name }}] Cuplikan konten:
              {{ result.content | regex_replace('\\s+', ' ') | truncate(250, True) }}
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"

      rescue:
        - name: âŒ Tidak bisa konek ke {{ item.name }}
          debug:
            msg: "âŒ [{{ item.name }}] Tidak dapat mengakses {{ item.url }} (kemungkinan DNS/IP down)"
          loop: "{{ wordpress_sites }}"
          loop_control:
            label: "{{ item.name }}"
